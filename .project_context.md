# Contexto del Proyecto — Café Colombia App (VPS Producción)

Este documento consolida el estado del proyecto en el VPS y el plan de despliegue/operación en producción.

**Estado Actual del Proyecto (Producción VPS)**
- ✅ Sistema de notificaciones mejorado: barra flotante eliminada, notificaciones centralizadas en el icono de campana
- ✅ Backend funcionando en puerto `3001` gestionado por PM2 (cluster)
- ✅ Frontend con build de producción generado en `dist/`
- ✅ Rutas de AI integradas y operativas (`/api/ai`) junto con middlewares de seguridad
- ✅ Base de datos MySQL conectada (health OK)
- ✅ Sistema robusto: CORS, rate limiting, manejo de errores, logging

**Configuración Actual**
- PM2: `ecosystem.config.cjs` (script apuntando a `api/server.cjs`, `PORT=3001`, cluster mode)
- Variables de entorno: `api/.env.production` y `.env.production` en raíz con URLs y seguridad
- Nginx: proxy para `/api` → `http://localhost:3001` y sirve SPA desde `dist/`
- Docker (opcional): `Dockerfile` y `docker-compose.yml` preparados para despliegue containerizado

**Cambios Aplicados**
1. Eliminación del NotificationCenter flotante en frontend
2. Centralización de notificaciones en `AINotificationIndicator`
3. Integración y validación de rutas `/api/ai` en backend
4. Mejoras de robustez: CORS, rate-limiting, manejo de errores y logging
5. Configuración de puertos y conexiones ajustada (PM2 en `3001` y verificación de health)

**Archivos Importantes**
- `ecosystem.config.cjs` — configuración PM2 (cluster, logs, env)
- `api/.env.production` — variables de entorno de producción del backend (MySQL, JWT, CORS)
- `./.env.production` — variables globales de producción (URLs, límites, SSL)
- `nginx/nginx.conf` — configuración base del web server
- `docker-compose.yml` — orquestación de contenedores (MySQL, Redis, API, Nginx)
- `scripts/deploy.sh` — despliegue automatizado con backup, build y reload
- `api/server.cjs` — servidor backend en CommonJS con carga de `.env.production`

**Plan de Operación / Despliegue a Producción**
1. Verificar entorno
   - Revisar `api/.env.production` (MySQL, JWT, CORS)
   - Confirmar `ecosystem.config.cjs` con `script: ./api/server.cjs` y `PORT=3001`
2. Preparar build
   - Frontend: `npm run build:prod` (root)
   - Backend: PM2 utiliza `server.cjs` directamente; opcionalmente `cd api && npm run build`
3. Recargar servicios
   - `pm2 reload ecosystem.config.cjs --env production`
   - `sudo nginx -t && sudo systemctl reload nginx`
4. Verificar
   - `curl -f http://localhost:3001/api/health`
   - `curl -f http://localhost:3001/api/ping`
   - Navegar dominio y validar SPA + API

**Comandos Útiles (VPS)**
- PM2: `pm2 start|reload ecosystem.config.cjs`, `pm2 logs cafe-colombia-api --lines 50`, `pm2 monit`
- Build: `npm run build:prod` (frontend), `cd api && npm run build` (opcional backend TS)
- Nginx: `sudo nginx -t && sudo systemctl reload nginx`
- Health: `curl -f http://localhost:3001/api/health` y `/api/ping`

**Próximos Pasos Sugeridos**
- Verificar dominio y SSL (Certbot/Nginx) según `install-production.sh`
- Optimizar rendimiento del bundle frontend (chunking/dynamic imports)
- Monitorear logs de producción con PM2 y ajustar niveles de logger
- Implementar tabla `ai_notifications` en MySQL y exponer `/api/ai/notifications` para persistir y marcar como leído desde el backend

**Notas de Seguridad**
- Mantener secretos (`JWT_SECRET`, `ADMIN_JWT_SECRET`) seguros y rotables
- `CORS_ORIGIN` debe incluir el(los) dominio(s) de producción
- Limitar tamaños de payload y rate-limits ya configurados

**Rollback (si aplica)**
- Usar backup de `scripts/deploy.sh` (mantiene últimos 5)
- `pm2 reload ecosystem.config.cjs` retornando al build anterior

Este documento se mantiene en `/root/CAFECOLOMBIAAPP/.project_context.md` para referencia y coordinación del equipo.